package net.doge.sdk.entity.music.info.lyric;

import net.doge.util.common.CryptoUtil;

import java.nio.charset.StandardCharsets;
import java.util.Arrays;

/**
 * @Author Doge
 * @Description QRC 歌词解析工具类
 * @Date 2020/12/15
 */
public class QrcParser {
    private static final byte[] QQKey = "!@#)(*$%123ZXC!@!@#)(NHL".getBytes(StandardCharsets.UTF_8);

    public static String parse(String hexText) {
//        String src = restoreQrc(hexText);
        String result = decode(hexText);
        return result;
    }

    public static void main(String[] args) {
        System.out.println(QrcParser.parse("5D7AD39FC4851A7BDD06AB022DF674CD93A0E60BB0F07A7769486A61FCF49E4C8046D424D2998B12DC4137FA98B76E625E1946A34560B77ED7082FDEE6FF17C175A80707824ABB70B608A7C8FA19511D20F7385253501C18EBE7732ED695903CF67D49EBCCFD9C397FCA3752C2E4E05975915931A231710218651C2F4B27D90211B2F881D79ADE75EB79AF4FE3F6A70FD1A460A9EB91D4080EC685F5262FB98A07355AA335B40A3DBDCDA3BC51BD31F3C5A05C70CAFF2F29A0943A5EE938D7A52D0E8FFC71F3E9036D9C10C0C13D01503D2A69896EB223EFCDC6C603A45ECE66C3E354BFF8159D1642A3BA7B2F52AF390C65F3913D3A9678675121AD510B0795F23A69F632585CEE4D09DC1AD0EC7A901BC4E376E148A07AB77F6A5B5A8D5EB88A5903364E4CB59DC334555B49951ABABD5119A4A56CF7446AEAE08EFB9573F00B950C38F9BBA841301AFC5AD78524EFDB9B4699EF99C1AAB252F8A225A575D251AE14DCC650F99B4B5F465F7E0F637ED55DF7C518D6CE4A02AD04CF9E8983490EE86D826D8F3C82D4B33FD33271D466A082C2F9B5C0D139F806877D01288F1E38777C14D7D5FFC1BBF0A354FE4E9C3366DA29EB3DEF7EA4026A69313F13B5372C0D0C50F862EDC3F23B80D321FEB8210A333F99AC0BF447F973B0F8B909FA656150AAB9646E250720CB5D135B5C3A012BE5AE0F6E147136378D9160C8D938681AD15A55F7279992F2F9CB67C8B768E110753FCE65CC4654E4CCEEAFC12C3095B6C77FBFE4B83D1896DE845D1B76DF7FA663D85AD33DABBC134BF9E41ED8FCD9F9B9C783A75099F5C62A4664606F790E2E0C131654725D9F62B44DA209EFB83DE61EC526F6DF95736EA294D055544983E40A9607448953F4BABA07DE2E92B01EC65885372C29128A4B2629BDACDC17F367B7EF8028C81AA5EA277E7E40643E654F22E458D22EB4246482A6E7D293ADD3FD0BE4968423A8567567C3112143E9517183743245E11DBAB7306545DD194F89C8962467A4F6653357B6E52A93563F918E747A78B24FC2508D4C53F78BC63BB52E35926A26BE1ED0337E139D1E7813EA1E28D9EE9CE8649BED2E3106EC0EA330E9F5608FE916214A99E25CC149A677A53A512188A4CDCC6067367C87D3D401E28CF6F87CE44B60628C03CAD30CBA4806043F3A45FA8CCB3A7D14088E1DAF8DA9C82860C5F8E0482B5CDC11BB0C19927D2EB73C1172D823AB18EE489D2DEAE4FD897D388427BC7B6D14001A566C5357F7DF914913FF4963F065041B7E950E31E9BF21C26277100266F705E085D037AC332AEFA89A900F67F8E435E9E896E1A11A91DB35818B064DE44DA3C2F226011D9153ADDCEA312CB872ED029450DD6FCE90700464F1285FABFE804726D012AD188F8673A66389AA53332F87A25B06964A66CD8AD61A5877A1552336527EFE897CB8E36F669088DBE813D8184580207F50FF010267FC2DBE1A32C4B36630BECC2489E70891BC724C04B08991E61084004090653B5782929B1A1805804C58BEA3675A00BC39F89E0AD15D2ED3905A780BEB03E122C580274B0C679A0D8D1DFC8FC5EC4F99AF4387765B22E7062DFBE7770B7EB7890FAA3A91CFFB2EE58191BDD164EB7A42475EF42CDB51020A4BC9BEE2B89C5F84E2EE6950531FF553752531231B4B20A4A00441225364941D8274718159EE17CA6E74968C0EF6D309CDD30B2E61C18B57F5FBEC65B32E6595314AF0CDF59852519297CF8D3E83582F8E3350A469B315F86FADAF11EF54FC8157729A4A5C7C9C49E2A0E6C4D51CF0935B0601803177A3362F8391E013D67298BA37A0246C10E40871B51599561096804221C8E555ED05AD1D78E00A12673C73AB549508BF35AFD558C4DDDBE970198AE820B11C13B7F240DA22A5DF0A698338ED3E794BB89D8FB31265321358112A26AC657859933BC6FA9E91F6ABF59DAD65D022AC852A6E48D6134E614A1B895878CF9C5559B9A66AA23E21ACD0252C8DA83459BBC61DE094761F7ECE11243EF7667D59A906706A490CD68C805D9C737C764F51CB35DBF221E1C051F4ADDCB7ADEFA55CE565A103101BD8BFD42D7F40FFEE1F0D62230B6EA3E5FAD622EFDF975806953A80933BD2F2BE8C0FC8C55BBC7F9A381B28B85689C93E48190FC09D288FC4ED3DBEB968B3F44080CCDA962A97782DC1177189EDBE451F94B5805469A8B3BB5F08231AA2E192A355E83FDB80F4EFD85EB3FE7890B2C8790EA61889BD152C999CB1C69FFA6B8097A9B668C84BCBBB6055C21C37479A55BEE3905464ADD7D47BEEDA8AB721CC6B4A3F0F429618D36C6CB00D5C129EF7708A278DF2881083148FA2C75AFCEC1A69250A9D0ABA486136AE2C4C6C5B493243578D57C1AC3F7C707AA81A650DAFE5E7C95A77B95172C3E34E5EB3191E1FE8494B5D524C34506686821E9DE356011AEF0BD4521AB16128CA9DD1D595D12A7A180528B0ED950023256C03C13D44260E938DBB18DEC276F586BDBC27E24E1F88E4B2DADE27541EA2DDCC52E92F5E99B5A10FC4A1B5D8E44192628B8C0E7991A157A1795E6F78AFDC160C42BFF16C332064512A90691565B26DECFEACDE00CC2A50F1318DF1398218A9C09DAAF9A57B8C40498B56E6B4A806B5C8287E743BC7FC5F520D54CB0D6305DBB280DA02D2C55D51C2F5AF686D6F2A2D7C94803996E00B1288DA21304FCDA682732132BFDFFC9565BA4F4201F3031B9C15E04ADCEDD691A6131C70263271677DA11B464B92EE3EE33209F0538A37EC4346DFF0F6429C7D52EA991251F1A14D0A7BE2AF0391C8C9D8208B913BDCCE34D68A8C562AF3332E27B6C8618D909FEAA3C85DB3906599F57F0A6E3F19C0EB541BA6E5E1BECFD1E42D54D750845E31A9CCCBFF607B22D4CB1D59234721BC3BAE0E052F2A08B007D9C27A1F614B00240BEBF442313D44C713E16C071D222FE72049E43ED2A5BB59983CB2CA7CD5827C3B4A46469B98D6F61E66B43D90C07B21E428040B1963DE3FE61EEE6755F62A852FEA008CE04ABFA85605C1287D6BC554A185D215684CEFADF5F59557593A83D52B54DC5751D92651E1E1CE2D918DBC2AA91E1A1E628F1ED61915FB973E3613206A2E08C681BFE87DF7AC49CB5AAB48255E0B7F52E4F8264ACD081EA5D0A40E515707C42BF2D2EAC52717382EE8190B18C804D64D0416EAC618FF8411C4E3C67733F76C1C591CAD8C043CAF29A5E9224363739A487CF49892470137E162BC2EABE273B9831449BA13B21A302857A4D2E62262345C6116AAED6310514D1074E6CEDC4F9CA663C58C9B1C0BFFA0855F8569457B06B3F8FDC2C8BC652E1BFB533ED69578BFE8611E7D1D8F109721B3BEFAE0611DC29D82746AA0E094FA739F49B5B68458CA851DC89C122DD32A5A050BDDD57C29E0B5B969A1137A236D7BECA63790794A224010D37A2300D207EC3735129E3A76303B6FE12CE44F534C0235FA5D5435D4E6448B78DFBC1151651842E62F4D0D95ABC67514CD802E7B47FA9785D9D302868157EF655854115C1656A71B15801D91B4A3B34ACD4FEAA24189152955A1247C3AE73253B5B77DDACA8ACE365A76CCC2F583D32C44265AE01AF42C51C9FC1EA89A838865013CE80170C9A4255C0C33287305DFC700E78A665D1AAE3B10F491D9AB15C21B31AFC51365FB674CC70C2D6BE5C9E95B9B8A21FA35423D1B464F5E1F9748FDE8FAB19943B5DD054CC17048B7AA959412571506919F5FC601987A14D6332F5CDE88F6DF519B4E2D8BD9E5C2AE23EC102D9709D01C05BF83C4AC7CFEB576B559F37B206DB91EFBAC59265966C0FDBA03C48981D0D4594DC5AC2F347B49AE17F0924BE64C3288CBF612857E865793DF0E56403C0B4F03D71EE4848B14E5107B9704C822A58E6DDDC8643B0D5E1E71EE6AD109550B518ACE1E9141DCA91C5D0EAB2C3B0E5B6780C8EDC5811098A6DAA27A10273D3BBB86CA9093CDB5EA5076DFEF1495FB5FA21C1B364036E24FAD1466CD442E6F4A598A305209D9DC943E046481A762EFB829A6D6135F7B4AF051564605B5F8DD6F3362CC39AD817B210B445E45A420BA4590D65D07C2796B7AE8F0873FFB1324D6C276057DDAD056FDFF6E5E3BBC7D3524C851642761D63930BE85FA6AB88B9DDD785FCC0EE518D26F17CE3D24B95FAF90FCA04900A561EAAACED6044841551F1BCA0F6EA81529B69A4A64E1A5C2A362B1E210AED3024690FBDFA7FEED08070DD7B828A6A5BCC5E3BE5EC8C6685E84530620AEACECEE9ADD451AACE5B11ACD9A2B434C598D6A6AE76FD963437EE825823DCD2F2CF19736434BCB2AA40E0F5F68E572A9AE8777D2BEC56AD354B8DD4487C25E15A2E3639900D400E6B8921A192E2E40C9BC0F39703A1B243E75C28BFFFE81D5AA465B9739DB5DF8F4C10E5A0ABDF86017C8B2EF207635B093F43584D20DEAB57BC6F6AC0953566056D9C204900D0AE47A3353E43F28A09E4D78F91D25F2A0C4483C89587A792EA4F8A445F46EB94670192B5717A324EF7660E08390C96B76F99D86FFFE07C1AD715AB5F685D40C8C48AEFD419F6989B3EC90B53470A6767F457D6B2285BA7EA26ABDE87E56AFB36B949CF513C23C4311214D3A8A48E6C00177E4D7DD6AE777F4AA2AAA44E1F5C11BA4855ECE181875CF2BE04E21A8A45DD8E9327B382D741214D560C048FED3BC0D2AF89BAA049B3102554FC791A5E838F24D5403344E6505F0EA9BFAF3AA6025E0A9E64F8B0FC22C81948082FC46474C9DD1117CFD2673B8562BF1FE0104E5CDAA71A9B72B0876248D8E8C381DF7605DEB72C8D3F0EE0FCAAE69D8DFF599C6C86D14DAE74596392F88BEB4CA85D4D494FD625178E9F0FAC729DC05CB6A97D1A21AAE1DBC66E5329E80A54C54B03214CE0947E933FC68E048540D014202099EFE885817D070125718E0AA1CFE6857B7EFDD63C2C42314B2BAC3BBCF1C1929FE7EE5A30567C7B92A006C8263A38C0202368DBE8A296E662777FF236DE2DDAA83C247F7A7224CAE95207EC54B907B1702B40F96F5E0DD97F5EEEB2072099FD3AFEF035B65A06BE182CE5F931DF536CD889EDCCAC76F56AF131AF1B8FA0FD85AD0EB28557456020BAC790D58EDA1246348C0799F20B178C755F8E16611608EB288163B3A945ACD3F224587AFD897A178DC223E509F5759AB983282B9AF82B85BBB3B44F1350E858096A7F5138E69B53D821A4F231E7423FE5EAA2AC4405A8A5897E2E9AABB137D8E310EF2E58414E3765179BA5FFEEBA7C4E19D3C5E4F0DEC3FA9D10DEF63A5ED6710DADD6E355B2E92510E6FBAED7350746ABBDEBC133EEFCFA4A962579B48600CB166F7BB51A4BD522F2FF83A7502279A207205413E66C5ED5C4660224061A43B9651889C603707888BE07F17A905E3A8B9B3CDD6872336352ED921E1FF74C3889ED3A1E023D581E6DE3DD42BF7502F048C8E918E968E9F53F5C4BBA2D596A5B316BE3E8587874F0B386637E2A10B66E934F8546F02C3049279CEF541F3BAF038F3E15B0D1E6FA1C0AE8BF02E963AEEFD1D7972722CF725B25E118AEA9122F2B0A563DB42962EF3FEB8439ECA1C0ADD4C16340DE53C72F0635FAB44DF340E3A4367B8CFAFFC84C8558EFDA5622904255D559438F0D439E13EB65983694C6EE1D346B0C075FB111442529B6FAAD4F3F819128BD21A1D2C9C74FEFB4FE3C7C35D2F1ED487895FA4C05F7C3156AD5408245D86A1AC15519B20FBF5901E1BF196800E4CB69BC26494E56A1F088FC5A205BD95477EA15A8998B71E0B1DFBB8E44069BD4FB193D634BD1D16FE3A93454D77598344CF78CB68DDD6EA3CAC7074FCDD6BA4D121B6CBA17C63349216565C8ACD0140640AFE593EC412F295A1AFA965AAC715DC075C9000592A60BC900F1B1D39F3D9ED6594E7BC5169AF50DE6255005072C027ACA3885EB7C6395DCCCB720E703167F3D0F7403C23ACFE43EE9565BCD9C53F468DAA38A9E4D52794FD13DFFD4C0E715A6E27ABCAC0F3045ED4D68EAF9FECFD379C9EA34EA16A259E3042A13A389054505915EA8A8E31B688DD820CE0D446ACC939B6AAB41DA4C4FFAB3B15ED81FD84EDAD6A1C1CA294D5F24C7BC1F3897DF55980ADC71627C8CD8D3F4EC0DB7C91163E020C6181C0C06AC0A529B4C446CEA7A42643B33EAD4C4018CD56BE7CB4E3757649F09445132DACD17F3843AE660A9D04F4ABA90442BCECAF8EF946F7398798B8B9FB9EB2A8537855238637698548AEB6436BE093ACB9B49000686C0A0B513B039E8D57CF4274411DCB38A8897D05712598E10694780BB8D0E2DCD96B11290F218FE933E992C53817CF94614E376A139B25DAA5670F7B7163FCE5866E1BD87343A27AF0C4ECBBE5A81165AFFFBBD74BE25C6D6366DD0C7685E6ACBE51E14E5C7EF14C567A0D43F515D5718D1C777025A08A3DFD33178022E393A28CCEA82AC986FB6665424EE0F50827A7F4469733B8ECE60A77672E4EB981F9A7BC0128C0E94FBCC91B7EA86766A4BBAADF0412BA989023CA4DEA69B5F92BADC40B137B6EC12B0D4D427D2E472C08D58A6F8419DB44BEE9175B51F29E3CFED57A4B61E0F17D8BEC9E94E32E0A05AB20C59D6C92E76DAC95B37B7F7837181CC29DF724789C3ABA8BE0D4D72C3B4E533C019D3F429330F2C8EC10FC78D07633A7E3C04BEFCBA6BDCD8A1D3116E39C26025F1090BAD1E901C3EB2F02895E1B0B3D7AE354686D9FA41647309BEFCF071AC172C907EC4B70809D39301729A478AF5FC04495DCAAB274D1D49A33508431BD4AA891CF899011AF3AD8BD81596B15C86D9493BAF85530DDD44B8F7CFED9F6EB077977158EBE61E3DC9D2CFE359AE3FFB2390A851908C6BB6FE5112F4C5AF9F9D2F05266F413A292F948A102CFEC6D767B1FA04782312A9ABE934BDF16843937B9AE09F1EE05A59301AB858F4A75694EBDDC6F49EE54CFB7F2D157870BD7351996EF2B6C47367C68A64808A115E4339831B42A8AD37E7C60FF47078E44DB3F2739270A3F38F1DD0AC677A87560402B25FE2AA7F9493E6383F91371D0344DBA6A70753C0C67846AFF68F7DD768B360FC78C5A35DF63F631D2B2EA30E2004DAA464F438F1581D2DF87AFAD173BAE5ABB73A1094F0759A293FD43B711A9FB6E7478B82266BA1B0B181BA4AC69F3B15F63B8B6D2EB56A4C4946D9C2D3433D393FA91067DFDD4CC197CA124C90DE7AD383A7DD803AF67A291BF2460AE26BB0E5D65111877D0CA5F7B9015FA3C6F9F32652907147B271DB398FFA85396F0B6CBE0839A935E632F655B6BF201238C5D01CE58D80FF81AE30D46A6A035919D161C413656CF03CE5582B1053EBD008E005922882ED26C2A947D504A6DDC22BFAE5D5E49E05DD0DD83F9B26A9268CF8DB37ADEA86C81008EDB3CEBBC9F6051F10ADD34B47F08E3A543D36BA2F7CB2B6E786D59A91396E86480FF2FC561AA989DD95B495AADAAACD9F04FFF8B59C023327F033DB124560BEA668A1A644B5EAC36600FFFD088DB7155A3D02A4DA1DF523B4A1732DF85EBB1DD99C6103CD87D1045CFB45D193DB77FC50534D1E06C9A24EBD2FE797A4746304D214938788954C11C675AA5126EE22C4DB448A22D4257EAD9698085E2CB284A2A0B772AC52B65113B34FDFF4C250DE99D217752CDFEB4BB20F9FA89F21361EC3717689A907DAE9C2ABFFE7817F604A4A5C4A502E9E3DA5392D486BB7CA98F2F030F3BA73D13347A88E4A4D3777FC1206BFEC17AA045F668701CC6E10FA1E9D7B0EB0592662000934C56CD4BD8A54C785538C88C0BEADBEB8E6A1EB1A2D2391063779714CF7DAAABF3DA2572E3BB8ED591A0C19FEB201DAA8313E2A09D797BFD69B24005C6735FEFDF00E6A39E78265467ECF6A34267994941A7A784557073AD91DF74A7804AE6CFB5265D84A7561E639266981EE0BD654124BE5F697EF6E13D7905918EE71756909FF98E29E942531684D1595A048775856D7FDCC8BDBB38914D557F05066C8E09D76B115299CE96C0F83F2AF6C28F6B5867324F2AF5A64F450E4D16EAAD222589C0381B6225FFFDE3EC7274EFD1A6B6FDD080309E2E5D68771F42CF12573DA7608AA384064F4FFCB3484FD6C819245D2EBF7B6D673501BFCCE74B5B49B57E287D5E776FFE6330E9F13496C3AFE91BC535FE7D97EE8C7E8C0BE35F145C42BC49E7BEBC8E792586C0674D972CF70266B91A6F1A97585114EF7A597E590E667E54D81DE1FCBE9867D1CE4D316F5515D004B88AE124EF0185AE910BB83B6EB379BD84765BEB52B0C99EE95E535586C67DBDF4157937C71FA5F562BCE28529610CF3817ADE402057657B53275EDED29D7962FCE39F89A62F6E982AE64EF38F6C70F2EB246FF049D1E5974CE63DB0F4E7123E34D0854DD7FB8EE9949990F73D6B0BEBF872546068897C8783C88917EBBA7A076024E41A9137246DC41AADAFF62DD1B37C9F5F7A53563722FF28B6CC5DF75A3FFDD9433CB38971F35EB6A8B69B5DDCE0F28F24265D919B42C85DE63A1D5CE4E99CE97FCDFDD5A03AF14A71AB6EB8BB7730156FDCC6D7F410892AEF7F71217381AB6AE36F0FDDE18D38FD77FB714836FE0E1F052C0CF892D30D7F62E324DE163FF7F6CF254F3FEBE63319375B60B7F112361ADB3430805427BB4BAE5523987EC73A287DC0BD7FF8319E4AF21603CE0DD8464819F285C9585DC3CDBEEAA0F50DC6D18F7D3AA82F08BF0C977C57252863FD07B93B6D52AFDD68FA4891981B8F19D35EBFDEBABC8526FA23BFBDBD3FB209B0F23DF6E0662D61BD12EF93610628364A4993347BAF13BA9D4109630F8AFA4170193C8B5F2BADF89E202075CC42A34A90BAC3D6FC57C80C7FCCFCD7F0B355C31EAF183A0CEC2191FB1CFC035409324E33E9BC91662DF5098DF078B3DF06EA416BEC68ADB42F61AE20E983E7190B2CA22E38459D2E185BEE6270BD47C150E5502AC94EC838895CB870C937DD477BE1D313DA1BFB28592981DCA4C91B856999E7D8C14B9CA1EB1AD6D4B9A2378C5B4B38776D43F46663BB3EBA18FF1D230C2B69E797CE5279BC6F17F69F6CFD7BFD9098E610D420FC75FEF2291FB00F76D7081A46331DD999E2D8010049B3A5E73D1CD2EC29FFBC400577F0234EED5E051DC229E9517FAC64B4A982A22B213D23ADF98282E53330B5DDADFA552DED57A96735E63C77EE05461A16BD09B72C464D73C1DA863E2D30637D64BECDFAA31E760C354495E1A8B6BCC2BDD13C0D4706A381E99085ADF4B3BA7C3D401C25AA216B0EFCE32CFB3CEA5BE94428889654773FD3647460F9918CBB193DF02607079626CDDCBA65F9E95163506C07634D76C3033BBBE164011DF70473DECE543F9725BBCDDE5EA341AC21E05B461B16B31F6BAC19065A3F32B7EB3A3FD56109E2653D3781E9BE5E6A03414675F45E56F57008F241C34EB0C2DB27790639DB90B57279231517AD9C9C"));
    }

//    private String decryptQrc(String content) {
//        if (StringUtil.isEmpty(content)) return null;
//
//    }

    private static String decode(String hexText) {
        byte[] bytes = CryptoUtil.hexToBytes(hexText);
        int bytesLen = bytes.length;
        byte[] data = new byte[bytesLen];

        QrcDecoder qrcDecoder = new QrcDecoder();
        byte[][][] schedule = new byte[3][16][6];
        qrcDecoder.threeDesKeySetup(QQKey, schedule, QrcDecoder.DECRYPT);
        for (int i = 0; i < bytesLen; i += 8) {
            byte[] temp = new byte[8];
            byte[] in = Arrays.copyOfRange(bytes, i, bytes.length);
            qrcDecoder.threeDesCrypt(in, temp, schedule);
            for (int j = 0; j < 8; j++) data[i + j] = temp[j];
        }
        String result = new String(CryptoUtil.decompress(data), StandardCharsets.UTF_8);
        return result;
    }

    private static String restoreQrc(String hexText) {
        int hexLen = hexText.length();
        if (hexLen % 2 != 0) return "";

        String sig = "[offset:0]\n";
        int sigLen = sig.length();
        byte[] arrBuf = new byte[hexLen / 2 + sigLen];
        for (int i = 0; i < sigLen; i++) arrBuf[i] = (byte) sig.charAt(i);

        int offset = sigLen;
        for (int i = 0; i < hexLen; i += 2)
            arrBuf[offset + i / 2] = (byte) Integer.parseInt(hexText.substring(i, i + 2), 16);

        return new String(arrBuf, StandardCharsets.UTF_8);
    }
}
