package net.doge.sdk.entity.music.info.lyrichero.decoder;

import net.doge.sdk.entity.music.info.lyrichero.helper.QrcDecodeHelper;
import net.doge.util.collection.ArrayUtil;
import net.doge.util.common.CryptoUtil;

import java.nio.charset.StandardCharsets;
import java.util.Arrays;

/**
 * @Author Doge
 * @Description QRC 歌词解析工具类
 * @Date 2020/12/15
 */
public class QrcDecoder {
    private static QrcDecoder instance;

    private QrcDecoder() {
    }

    public static QrcDecoder getInstance() {
        if (instance == null) instance = new QrcDecoder();
        return instance;
    }

    private final int[] KEY1 = ArrayUtil.bytesToInts("!@#)(NHLiuy*$%^&".getBytes(StandardCharsets.UTF_8));
    private final int[] KEY2 = ArrayUtil.bytesToInts("123ZXC!@#)(*$%^&".getBytes(StandardCharsets.UTF_8));
    private final int[] KEY3 = ArrayUtil.bytesToInts("!@#)(*$%^&abcDEF".getBytes(StandardCharsets.UTF_8));
    private QrcDecodeHelper qrcDecodeHelper = QrcDecodeHelper.getInstance();

    private void des(int[] data, int[] key, int len) {
        int[][] schedule = new int[16][6];
        qrcDecodeHelper.desKeySetup(key, schedule, QrcDecodeHelper.ENCRYPT);
        for (int i = 0; i < len; i += 8) {
            int[] in = Arrays.copyOfRange(data, i, data.length);
            qrcDecodeHelper.desCrypt(in, in, schedule);
            System.arraycopy(in, 0, data, i, in.length);
        }
    }

    private void ddes(int[] data, int[] key, int len) {
        int[][] schedule = new int[16][6];
        qrcDecodeHelper.desKeySetup(key, schedule, QrcDecodeHelper.DECRYPT);
        for (int i = 0; i < len; i += 8) {
            int[] in = Arrays.copyOfRange(data, i, data.length);
            qrcDecodeHelper.desCrypt(in, in, schedule);
            System.arraycopy(in, 0, data, i, in.length);
        }
    }

    public String decode(String hex) {
        int[] data = ArrayUtil.bytesToInts(CryptoUtil.hexToBytes(hex));
        int dataLen = data.length;

        ddes(data, KEY1, dataLen);
        des(data, KEY2, dataLen);
        ddes(data, KEY3, dataLen);

        String result = new String(CryptoUtil.decompress(ArrayUtil.intsToBytes(data)), StandardCharsets.UTF_8);
        return result;
    }

//    public static void main(String[] args) {
//        System.out.println(getInstance().parse("1D54B68769414E57958463319F55E99A8B6EE0C3CBBE31581471DF41A8EEB70BBAE2CD07B383E9AECDECB6BD96069EA868A23DC173399D0E076D02C1ADDE6764D5190E3567D05A1BB8AD17DDDA06C83CAC9B2B3EE671534044924DB2120AA83A5011AFB54633B4E57B9AB35E1B6E3B0B3201E00F483DBCF4B963764C3C9CCEB3F4FB6EE82464BF07753AF2E85D5F6F4E26EB39C8CE3A39A9269D76AA0DE378452CD42D01892E4F6D2255CA9C977A289F00D4363C6FA707BCDB6EA796630634FB346C95845354E47F5060AA4DE45ACBE3A4366E9B720224F20B2B711C48D5D4964320C4D5ABCF13D9A1C50CD1D652136205F4A4F84B23317169B9ACD24AFA6020D6DFA9738795FAC78D5DF398B23A55F0A70FA43ECD939F34D0D69088C29F9D9710DB6E3AFA6E1D0CB8EC0E7B60A3077F3F5BA961C5576D263DAA680B554C002A480120B8F9AB879F7C6730149D25B3399376F9E2F5A997BA29D331D6AC89664197C8C93CE9E2BE7EFC333F1309A9108A0A4E9F898101AC8421D189D09D9435CED9822ABD59CB53BDF70FAD098C7F5CD6441D0DBEB9EDBAD5771E1526AF5467BFB4E6BE19AA94E0FB4FB8B86E3B90012C679DFE61013D6332987F9BFCFD9D8B834C279A93EFDA2BC90E26B178A165F37C56260E09EC6CFB18F78D6CF28FD105F5717224DE6BAEFDDC5546A675B2CB0E8908EB8C7560D651D64DCE111CD9F75541A818D446DE74C9B3A09F094EACD938A9972CE60365E3617ADF20C425D6ED5D37B292DFDDFB2B771F5765E7759D704798F922D9B73E42E7FE95577308DB05A5DA37594098EE0D1AA576942EE86E9F7DCC00D03509B409CCD1F7BF6FC627DAD8F7CEBE05A83E7E3CC958CA87C1E0B74122658858628B5AE0DA3647F1245D397A4801E3401A403238D517B3C4E8243365EC07A512FCBB2CDECC92A714A37EF2B68E5DFF95BE1EE20C08545720080AC717892DBB8E814FE6DDDA7E7EBC1C0C3478E9C751A960F21EE32876633B353F13B0E3DB247E8BDD221D57CDF1684DD8F8162202EB96E78E37B4CDB205731165431B687DFCABF131F608A2B5AC1C0AF1C3DFB10FF1F1E123852F82C6BA7FC39099175FEB7105997C4BA500BC77032702EF3A84F52EBB7D40BE55EAF0CF864E371BFABC54FEDC7B224472EA02F77FEA4143C72F7AB4AF020C33585A1EED0148E40FAFBCF7A6CA6568B992DC7E9B763F2ED47E59016A3A48F17DC46772E8AFBC143080A42EA414773764E9A5B34CA66137E244B2604A5655D392DEFA550DACA00A8E1C3B15B34A9620B501A236D9F37B88D953BEC9FF226E50A54C62A9BE28F860DC6BEE40DEE66CFC78C809EC044A3A655366FDDA56F67F0B3ED8C9FC97C003ED12386EDC3DA38E33D2E38CBD855810EF67683AC8A2418B202DCF770A6A67EB6BF004CBF9A0683A6A3614762C50144C220FF431CA718FE8D58329949FB957A3D9728826257B3959FBC554885E88945D686E2011CB579BF08BDD3D48C6262996980AC2D019469311E19FE50D503C438D8B6E89E08C764C251A62A2E06FB7C8BB3C1E9DA3DB5D50DE35B0A0A2769B1CE6170A1D35AFC20CC131A7F1582B731D566491717BF8C24000EC36B7CCFB70F02D40B172893ED0F771A6E7ADBBCB314D1F28D689603255060953DAB1B621BD8C194E11B6E65BA1BE3882AC552EB43B95DBCFFD9811120A8F45EE5DA648F28D0B7994CBFB1EC764E23B2DA024FF3CF77EDCDA90B95629E0506B59BBA5EABCC62A5A77F30549FAA11AF32A36D0F6B2965C038680BF961ABBFE3F11D06EC2F88BAC500C9B818E0D7B5CE9B108158BEF7695F4BE3B2C4C5048266374B8E086E435B0D1A73C6D57CB57F232EA5878A33D53F05F0C42F38E9C7020C268FB235E6571C6DD33CFA4525DFDB9AD2564AF367C3649672C7872B193B85C5520E99F0C10D473BE1BCE23DACCDC77B37EEE3A9E5C18CEC9F7B5032C9B81BE8F5CA5D245D439D53A72C045F2C60E21C918FD28D7C18D2D1CE5E40D3F66321A74FB8728F798360EEF1D8C7C1551A668B6468180D62FEAD25B08E752DA2A491165C482C9487FB877D1F28FAA4DFFAC064CBBA8C9C080F2417596FDB368F722E974B6868F13EB42FF86466D7D8DC9D72FD2DA02B88C4A897046657E86BC0B91BAFE83917371EED45A2D625C87FD9A923FEC5DC0CB896653B5E05F415A9AA4C1DD440CB5EF1CB55B8FF78767CA6A86C1C26588A7D4F64EC7E4A2AAFF4DF8FF17E400A9E5E1D646D38C551BED8EA8036992413F7D85186273FEB23043BC434EE1A1C455DC1058BE490B22F59E17F2809B8F7DBD22D0D66C99592C8D811B343C337F25A79A82B1756354C8A7A4F3AD63B8B8FDFEFD3CC66AFB2095ECD3ED1D3D0815606A68E2810DD66D178034FA0A77F2ACDEFD4462BC7CCC09ABA0E1DFE929E06054D1EE15B7204CB0DFC4C669418343E4ACCA12DED2E3BA41CDCE62A99C03B615923CE07052811380D5C17982CD8A9EBA58697CE2E2CFEBC5DA25BA7DAD0098AED40B455D98756DC3437EBF4A1F17871BF4CE38220268E93A68DDD0E055D2ABFEE7F5FC0ECC77ED9D30F3A5F111B93B98D5F66E9FA6A011DCB24611AD182382DC625F0E73C0A4C09A1884FCAAF541EE6B47B5A7072BCFA3556231DE2DC85110F9A21CB4E7C5315E85BABA69249C44DDF2D220494C6348463FD94CDB6BB23E5A3F8032D2FEC538B3E4A3A969D13EE68086AEE5210D6949D0F10F0675D6B25B9F82B04EBC4A4FCBBC075A88C0CE64935D02B673A232FA0F1025D3A476214AB9E86A9FF8AC2C0D5D699E9A6D83D6B1A9BF491A3475F8F9C5D9A3B5CB6FBC03A295624AE5F6035342F34F3EF0B3ABFAAFD0F7873A7DABB09A410711476B4F32B270D952BB9CEABAEBB3ACB8549C99A30632094B4BFC4B79D00B527D7537FE12EB852ED63A39437A01B1BE5E1189BC8867773E33A043C87693A17F6109D61F5737A9565BF290C8C3AD79C0428DCF16EDF315B4FD293E964E501B5C3619FCC24C177356A7CA5931C5986558554A89DF038E8145DB25D47028CB4C7BB8C837FF0FAF78B7147BF8AFCA0E0195FA62E6390CA91567A96298D0C76FFFA88DE3EE3AADAF1C84B4A7DC8074135AAFAA745930A4D737086D472D13172A68BF30D6C1B873AE80A62D165EA608106CA07D8FDAC82EFAC0153AFA1103E35185F62BB5D91E7DE96EC72160FD577CA18511E5DC7D04B2FCE8832BD7CABCACD5989F3334885CCDF4DE4FD2841F690F71E51E32A19A5E79B395D4447D78AFE56C0999361A36B422603F6C57919B1F401907DDF1FC6E62A91FF78D490B7381802F184A2233C3B09306E31E7D57114A4D3E84D578C4C71F808A8E429BE3C7CE1DE7CDC45C28737A8D6CB3CDB15F39F1522C15F66AB6FF4672F81F1A2C45124BAEB9442DE63E6C6575C048E0156169EE10DB93A30DBE484058F023FD40AD41AAD3D29B391775711710D455F1BF58CC18D2DAF1D8BCD3291EFFD97B9EF0705AD21130C7B114741A1901CA8C9587090BFBC3A357F0CC58A85F436DA08237071B292F61F96119657E78A37DD521917CE418E90B368BBAAC7D86D5B04C1773050417AC46741FF2A8EA3A91BFB0146E99D8C58A9812EBCAD82F81FFB83EEABD67BABD6F4E751A974F012ECC9BD607B7B2670F11"));
//    }
}
